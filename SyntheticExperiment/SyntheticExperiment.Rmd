---
title: "Code to reproduce the analyses of the AWST paper: Analysis of the Synthetic data<br/> Figure 2 and 3,<br/> Supplementary Figures 1, 2, 3, and 4.,<br/>Supplementary table 2,<br/>Updated after review."
author: "[S.M.Pagnotta](https://www.researchgate.net/profile/Stefano_Pagnotta) - Dept. of Science and Technology, Universita' degli Studi del Sannio (Benevento, Italy)</br> [D.Risso](https://www.researchgate.net/profile/Davide_Risso) - Dept. of Statistical Sciences, Universita' degli Studi di Padova (Padova, Italy)"
date:  '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document: 
    toc: yes
    toc_float: yes
    df_print: paged
fontsize: 11pt
editor_options: 
  chunk_output_type: console
---

Here we show the code to reproduce the analyses of: Risso and Pagnotta (2020). Per-sample standardization and asymmetric winsorization lead to accurate classification of RNA-seq expression profiles. In preparation.

This file belongs to the repository: https://github.com/drisso/awst_analysis.

The code is released with license GPL v3.0.

# Install and load `awst`

```{r install_awst, eval=FALSE, echo=TRUE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("drisso/awst")
```

# The synthetic dataset

... We then created $k=5$ groups of samples, each made of $M=30$ replicate samples, randomly selected (with replacement) from the original set of 80. For each group, we randomly selected (without replacement) $J=500$ genes, whose expression was altered according to the following multiplicative model.
$$
\tilde{y}_j = y_j \cdot (0.001 + r_j), \quad j=1,\ldots,J,
$$
where $y_j$ denotes the observed expression of gene $j$, $\tilde{y}$ denotes the perturbed expression, and $r_j$ is the realization of a Gamma random variable with shape parameter $a=0.5$ and scale parameter $s=1$.


```{r synthetic20200413.RData, eval=FALSE}
#BiocManager::install("seqc") # uncomment if necessary
rm(list = ls())
set.seed(20200413)
library(seqc)
  
ddata <- get("ILM_aceview_gene_MAY")
ddata <- ddata[!is.na(ddata$EntrezID),]
ddata <- ddata[!ddata$IsERCC,]
  
feature_annotation <- data.frame(ddata[, 1:3], row.names = ddata$EntrezID)
dim(ddata <- as.matrix(ddata[, -c(1:4)]))    #[1] 19701   384
sum(duplicated(feature_annotation$Symbol))   #[1] 0
sum(duplicated(feature_annotation$EntrezID)) #[1] 0
row.names(ddata) <- feature_annotation$EntrezID
  
dim(sample_annotation.df <- data.frame(row.names = colnames(ddata), sample = colnames(ddata))) #[1] 384   1
sample_annotation.df$lane <- substr(sample_annotation.df$sample, 6, 7)
sample_annotation.df$flow_cell <- substr(sample_annotation.df$sample, 17, 17)
sample_annotation.df$sample <- substr(sample_annotation.df$sample, 1, 3)
  
sample_annotation.df <- sample_annotation.df[grep("A", sample_annotation.df$sample),]
dim(ddata <- ddata[, rownames(sample_annotation.df)]) #[1] 19701    80
  
M <- 30
nnumbers <- c("01", "02", "03", "04", "05", "06", "07", "08", "09", paste(10:M))
tmp <- c(paste0("A", nnumbers), paste0("B", nnumbers), paste0("C", nnumbers), 
         paste0("D", nnumbers), paste0("E", nnumbers))
  
design.df <- data.frame(row.names = tmp, sample = tmp, original.sample = NA) 
design.df$original.sample[1:M]           <- sample(rownames(sample_annotation.df), M, replace = TRUE)
design.df$original.sample[(M+1):(2*M)]   <- sample(rownames(sample_annotation.df), M, replace = TRUE)
design.df$original.sample[(2*M+1):(3*M)] <- sample(rownames(sample_annotation.df), M, replace = TRUE)
design.df$original.sample[(3*M+1):(4*M)] <- sample(rownames(sample_annotation.df), M, replace = TRUE)
design.df$original.sample[(4*M+1):(5*M)] <- sample(rownames(sample_annotation.df), M, replace = TRUE)
#  table(design.df$original.sample)
  
k <- "A"
wwhich <- grep(k, design.df$sample)
synthetic_data <- ddata[, design.df$original.sample[wwhich]]
colnames(synthetic_data) <- design.df$sample[wwhich]
  
the_genes <- rownames(synthetic_data)
no_of_altered_genes <- 500

genes_to_alterate <- sample(the_genes, no_of_altered_genes, replace = FALSE)
the_genes <- the_genes[-which(the_genes %in% genes_to_alterate)]

for(jj in 1:M) {
  tmp <- 0.001 + rgamma(length(genes_to_alterate), shape = 0.5, scale = 1)
  synthetic_data[genes_to_alterate, jj] <- synthetic_data[genes_to_alterate, jj] * tmp
}
  
#  k <- "B"
for(k in c("B", "C", "D", "E")) {
  wwhich <- grep(k, design.df$sample)
  tmp_data <- ddata[, design.df$original.sample[wwhich]]
  colnames(tmp_data) <- design.df$sample[wwhich]
    
  genes_to_alterate <- sample(the_genes, no_of_altered_genes, replace = FALSE)
  the_genes <- the_genes[-which(the_genes %in% genes_to_alterate)]

  for(jj in 1:M) {
    tmp <- 0.001 + rgamma(length(genes_to_alterate), shape = 0.5, scale = 1)
    tmp_data[genes_to_alterate, jj] <- tmp_data[genes_to_alterate, jj] * tmp
  }
  
    
  synthetic_data <- cbind(synthetic_data, tmp_data)
}
dim(ddata <- floor(synthetic_data)) #[1] 19701   150
  
annotation.df <- data.frame(samples = colnames(ddata), row.names = colnames(ddata))
annotation.df$sample <- substr(annotation.df$samples, 1, 1)
annotation.df$sample.col <- factor(annotation.df$sample)
levels(annotation.df$sample.col) <- clust.col <- c("gold", "red", "green2", "blue", "cyan")
names(clust.col) <- unique(annotation.df$sample)
   
save(ddata, annotation.df, feature_annotation, clust.col, file = "synthetic20200413.RData")
  
#tmp <- cbind(annotation.df, t(ddata))
#write.table(tmp, file = "synthetic20200413.tsv", sep = "\t", quote = FALSE, row.names = FALSE)
#write.table(feature_annotation, file = "synthetic20200413_features_annotation.tsv", sep = "\t", quote = FALSE, row.names = FALSE)
```

```{r setup, echo=FALSE, message=FALSE}
rm(list = ls())
setwd("~/Dropbox/AWST/gitHub/Synthetic20201003/")
library(knitr)
opts_chunk$set(echo = FALSE, fig.height = 4.5, fig.width = 11, fig.align = "center")
library(cluster)
library(dendextend)
library(clues)
library(awst)
jobName <- "SE20201003"
###
# get data from gitHub
base_path <- "https://raw.githubusercontent.com/drisso/awst_analysis/master/"
ttable <- read.csv(url(paste0(base_path, "SyntheticExperiment/synthetic20200413.tsv")), sep = "\t")
annotation.df <- ttable[, 1:3]; rownames(annotation.df) <- annotation.df$samples
ddata <- ttable[, -(1:3)]
rownames(ddata) <- annotation.df$samples
colnames(ddata) <- gsub("X", "", colnames(ddata))
ddata <- t(ddata)
feature_annotation <- read.csv(url(paste0(base_path, "SyntheticExperiment/synthetic20200413_features_annotation.tsv")), sep = "\t")
ddata <- ddata[paste(feature_annotation$EntrezID), ]
rm(ttable)
tt <- table(annotation.df$sample, annotation.df$sample.col)
clust.col <- colnames(tt)[apply(tt, 1, which.max)]
names(clust.col) <- rownames(tt)
###
thisPalette <- c("#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99") # from ConsensusClusterPlus
png_width <- 600
png_height <- 300
png_res <- 1/300
save_png <- FALSE
x_legend <- 81
y_scale_ <- -0.1
y_shift_ <- -0.13
source(url(paste0(base_path, "functions.R")))
source("~/Dropbox/consensus/pkg/consensusFun20200415.R")
results <- matrix(NA, ncol = 8, nrow = 150)
colnames(results) <- c("what", "with", "ECA", "ECP", "ARI", "G", "ASW", "timing") 
k <- 0
```


# Figure 2
Performance of different data pre-processing paired with the hierarchical clustering (Euclidean distance, Ward's linkage). a) AWST data pre-processing; b) Hart's data pre-processing; c) Radovich's data pre-processing; d) TCGA data pre-processing. The "sample" bar indicates the true partition, and the "clust" bar indicates the inferred partition obtained by cutting the tree to get 5 clusters. The Calinski-Harabasz curve is superimposed in each panel.
<table>
<tbody>
<tr>
<td><img src="./SE20201003_AWST.png"></td>
<td><img src="./SE20201003_Hart.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_Radovich.png"></td>
<td><img src="./SE20201003_TCGA.png"></td>
</tr>
</tbody>
</table>



# Supplementary Figure 1
(Extended Figure 2) Performance of different data pre-processing paired with the hierarchical clustering (Euclidean distance, Ward's linkage). a) AWST data pre-processing; b) Hart's data pre-processing; c) Radovich's data pre-processing; d) TCGA data pre-processing; e) FPKM pre-processing with top 2,500 features according to standard-deviation; f) FPKM pre-processing with top 5,000 features according to standard-deviation; g) rlog pre-processing; h) VST pre-processing; i) Townes' transformation (null residuals with deviance); l) Townes' transformation (null residuals with pearson). The "sample" bar indicates the true partition, and the "clust" bar indicates the inferred partition obtained by cutting the tree to get 5 clusters. The Calinski-Harabasz curve is superimposed in each panel.
<table>
<tbody>
<tr>
<td><img src="./SE20201003_AWST.png"></td>
<td><img src="./SE20201003_Hart.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_Radovich.png"></td>
<td><img src="./SE20201003_TCGA.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_FPKM25.png"></td>
<td><img src="./SE20201003_FPKM5k.png"></td>
</tr>


<tr>
<td><img src="./SE20201003_rlog.png"></td>
<td><img src="./SE20201003_vst.png"></td>
</tr>


<tr>
<td><img src="./SE20201003_scry_dev.png"></td>
<td><img src="./SE20201003_scry_pears.png"></td>
</tr>
</tbody>
</table>





# Supplementary Figure 2
Study for the synthetic data of the effects of data pre-processing on the compactness of groups respect to the theoretical partition and Euclidean distance. a) AWST; b) Hart; c) Radovich; d) TCGA; e) FPKM pre-processing with top 2500 features according to standard-deviation; f) FPKM pre-processing with top 5000 features according to standard-deviation; g) rlog pre-processing; h) VST pre-processing; i) Townes' transformation (null residuals with deviance); l) Townes' transformation (null residuals with pearson).
<table>
<tbody>
<tr>
<td><img src="./SE20201003_AWST_silhouttes.png"></td>
<td><img src="./SE20201003_Hart_silhouttes.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_Radovich_silhouttes.png"></td>
<td><img src="./SE20201003_TCGA_silhouttes.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_FPKM25_silhouttes.png"></td>
<td><img src="./SE20201003_FPKM5k_silhouttes.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_rlog_silhouttes.png"></td>
<td><img src="./SE20201003_vst_silhouttes.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_scry_dev_silhouttes.png"></td>
<td><img src="./SE20201003_scry_pears_silhouttes.png"></td>
</tr>
</tbody>
</table>


# Supplementary Figure 3
Performance of different data pre-processing paired with ConsensusClusterPlus (inner and outer average linkage with Pearson's correlation as distance matrix). a) AWST data pre-processing; b) Hart's data pre-processing; c) Radovich's protocol; d) TCGA data protocol; e) FPKM pre-processing with top 2,500 features according to standard-deviation; f) FPKM pre-processing with top 5,000 features according to standard-deviation; g) rlog pre-processing; h) VST pre-processing; i) Townes' transformation (null residuals with deviance); l) Townes' transformation (null residuals with pearson). The "sample'' bar indicates the true partition, and the "consensus'' bar indicates the inferred partition obtained by requiring 5 clusters.
<table>
<tbody>
<tr>
<td><img src="./SE20201003_ccp_hclust_AWST_consensus.png"></td>
<td><img src="./SE20201003_ccp_hclust_Hart_consensus.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_ccp_hclust_Radovich_consensus.png"></td>
<td><img src="./SE20201003_ccp_hclust_TCGA_consensus.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_ccp_hclust_FPKM25_consensus.png"></td>
<td><img src="./SE20201003_ccp_hclust_FPKM5k_consensus.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_ccp_hclust_rlog_consensus.png"></td>
<td><img src="./SE20201003_ccp_hclust_vst_consensus.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_ccp_hclust_scry_dev_consensus.png"></td>
<td><img src="./SE20201003_ccp_hclust_scry_pears_consensus.png"></td>
</tr>
</tbody>
</tbody>
</table>



# Supplementary Figure 4
Performance of different data pre-processing paired with ConsensusClusterPlus (Euclidean distance and PAM method). a) AWST data pre-processing; b) Hart's data pre-processing; c) Radovich's pre-processing; d) TCGA data pre-processing; e) FPKM pre-processing with top 2,500 features according to standard-deviation; f) FPKM pre-processing with top 5,000 features according to standard-deviation; g) rlog pre-processing; h) VST pre-processing; i) Townes' transformation (null residuals with deviance); l) Townes' transformation (null residuals with pearson). The "sample'' bar indicates the true partition, and the "consensus'' bar indicates the inferred partition obtained by requiring 5 clusters.
<table>
<tbody>
<tr>
<td><img src="./SE20201003_ccpPAM_hclust_AWST_consensus.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_Hart_consensus.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_ccpPAM_hclust_Radovich_consensus.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_TCGA_consensus.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_ccpPAM_hclust_FPKM25_consensus.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_FPKM5k_consensus.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_ccpPAM_hclust_rlog_consensus.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_vst_consensus.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_ccpPAM_hclust_scry_dev_consensus.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_scry_pears_consensus.png"></td>
</tr>
</tbody>
</tbody>
</table>




# AWST procedure
## hclust (Euclidean/Ward)
```{r AWST}
system.time({exprData <- awst(ddata)})
#   user  system elapsed 
#  0.832   0.016   0.848 
timing <- c(0.832, 0.016, 0.848)
#dim(exprData <- gene_filter(exprData)) #[1]  150 5575
mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_AWST.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
add_Calinski_curve(from = 25, to = 120)
text(-1, .96, "(a)")
dev.off()

if(save_png) png(file = paste0(jobName, "_AWST_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = paste0("(a) ", mmain), col = clust.col)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("AWST", "HC", tmp, round(timing[3], 4))
```

## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r AWSTccp}
if(!file.exists(paste0(jobName, "_ccp_hclust_AWST.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              title = paste0(jobName, "_AWST"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ans[[5]]$clrs[[2]] # 5
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccp_hclust_AWST.RData"))
  } else load(paste0(jobName, "_ccp_hclust_AWST.RData"))
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
if(Inf %in% aCalinski) aCalinski <- aCalinski[!is.infinite(aCalinski)]
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccp_hclust_AWST.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, 150, hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("AWST", "CCP1", tmp, NA)

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_AWST_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(a) ", mmain))
dev.off()
}
```


<table>
<tbody>
<tr>
<td><img src="./SE20201003_AWST/consensus008.png"></td>
<td><img src="./SE20201003_AWST/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_AWST/consensus005.png"></td>
<td><img src="./SE20201003_ccp_hclust_AWST_consensus.png"></td>
</tr>
</tbody>
</table>



## ConsensusClusterPlus (PAM)
Result of ConsensuClusterPlus with clusterAlg = "pam" and distance = "euclidean" (other parameters left to default)
```{r AWSTccp_PAM}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_AWST.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_AWST_PAM"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ans[[5]]$clrs[[2]] # 5
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_AWST.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_AWST.RData"))
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
if(Inf %in% aCalinski) aCalinski <- aCalinski[!is.infinite(aCalinski)]
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_AWST.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, 150, hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_AWST_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(a) ", mmain))
dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("AWST", "CCP2", tmp, NA)
```


<table>
<tbody>
<tr>
<td><img src="./SE20201003_AWST_PAM/consensus008.png"></td>
<td><img src="./SE20201003_AWST_PAM/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_AWST_PAM/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_AWST_consensus.png"></td>
</tr>
</tbody>
</table>


# Hart 2013
[Finding the active genes in deep RNA-seq gene expression studies](https://bmcgenomics.biomedcentral.com/articles/10.1186/1471-2164-14-778)

## hclust (Euclidean/Ward)
```{r Hart2013}
system.time({
  exprData <- get_FPKM(ddata, feature_annotation$GeneLength)
  exprData <- get_Hart2013(exprData)
})
#   user  system elapsed 
#  0.579   0.000   0.580 
timing <- c(0.579, 0.000, 0.580)
#mean(colMeans(exprData) > -3) # 1
mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
###
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_Hart.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
###
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, 150, hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
tt <- table(clustering, annotation.df$sample.col)
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
text(-1, .96, "(b)")
dev.off()

if(save_png) png(file = paste0(jobName, "_Hart_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = paste0("(b) ", mmain), col = clust.col)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("Hart", "HC", tmp, round(timing[3], 4))
```



## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r Hart2013ccp}
if(!file.exists(paste0(jobName, "_ccp_hclust_Hart.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              title = paste0(jobName, "_Hart"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ans[[5]]$clrs[[2]]# 5
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccp_hclust_Hart.RData"))
  } else load(paste0(jobName, "_ccp_hclust_Hart.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccp_hclust_Hart.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
#ARIvalues["CCP1", "Hart"] <- tmp["ari"]
results[k <- k+1,] <- c("Hart", "CCP1", tmp, NA)

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_Hart_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(b) ", mmain))
  dev.off()
}
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_Hart/consensus008.png"></td>
<td><img src="./SE20201003_Hart/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_Hart/consensus005.png"></td>
<td><img src="./SE20201003_ccp_hclust_Hart_consensus.png"></td>
</tr>
</tbody>
</table>


## ConsensusClusterPlus (PAM)
Result of ConsensuClusterPlus with clusterAlg = "pam" and distance = "euclidean" (other parameters left to default)
```{r Hart2013ccp_PAM}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_Hart.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_Hart_PAM"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ans[[5]]$clrs[[2]]# 5
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_Hart.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_Hart.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_Hart.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_Hart_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(b) ", mmain))
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)

results[k <- k+1,] <- c("Hart", "CCP2", tmp, NA)
```


<table>
<tbody>
<tr>
<td><img src="./SE20201003_Hart_PAM/consensus008.png"></td>
<td><img src="./SE20201003_Hart_PAM/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_Hart_PAM/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_Hart_consensus.png"></td>
</tr>
</tbody>
</table>

# Radovich (2018) procedure
[The Integrated Genomic Landscape of Thymic Epithelial Tumors](https://www.cell.com/cancer-cell/fulltext/S1535-6108(18)30003-5)

## hclust (Euclidean/Ward)
```{r Radovich, echo=FALSE}
system.time({
#After restricting to genes with at least 75% non-zero RSEM values,
  tmp <- rowMeans(ddata > 0, na.rm = TRUE)
  rdata <- ddata[which(tmp >= 0.75),] #[1] 14731   150
#the genes with the 1000 highest median absolute deviation (MAD) values were chosen.
  tmp <- tail(sort(apply(rdata, 1, mad)), 1000)
  rdata <- rdata[names(tmp),] #[1] 1000  150
#RSEM values identically equal to zero were replaced into smallest non-zero value.
  rdata[which(rdata == 0)] <- min(rdata[rdata > 0])
#Then a log2 transformation was applied
  rdata <- log2(rdata)
#and the values were median centered by gene and divided by MAD expression of each gene.
  mmedian <- apply(rdata, 1, median)
  mmad <- apply(rdata, 1, mad)
  exprData <- scale(t(rdata), center = mmedian, scale = mmad)
})
#   user  system elapsed 
#  1.128   0.003   1.135 
timing <- c(1.128, 0.003, 1.135)
###
mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_Radovich.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
add_Calinski_curve(from = 25, to = 120)
text(-1, .96, "(c)")
dev.off()

if(save_png) png(file = paste0(jobName, "_Radovich_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = paste0("(c) ", mmain), col = clust.col)


tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("Radovich", "HC", tmp, round(timing[3], 4))
```

## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r Radovich2018ccp, echo=FALSE}
if(!file.exists(paste0(jobName, "_ccp_hclust_Radovich.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              title = paste0(jobName, "_Radovich2018"), plot = "png")
  ncol_exprData <- nrow(rdata)
  nrow_exprData <- ncol(rdata)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccp_hclust_Radovich.RData"))
  } else load(paste0(jobName, "_ccp_hclust_Radovich.RData"))
###
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
if(Inf %in% aCalinski) aCalinski <- aCalinski[!is.infinite(aCalinski)]
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccp_hclust_Radovich.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
text(-1, .96, "(c)")

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("Radovich", "CCP1", tmp, NA)

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_Radovich_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(c) ", mmain))
dev.off()
}
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_Radovich2018/consensus008.png"></td>
<td><img src="./SE20201003_Radovich2018/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_Radovich2018/consensus005.png"></td>
<td><img src="./SE20201003_ccp_hclust_Radovich_consensus.png"></td>
</tr>
</tbody>
</table>


## ConsensusClusterPlus (PAM)
Result of ConsensuClusterPlus with clusterAlg = "pam" and distance = "euclidean" (other parameters left to default)
```{r Radovich2018ccp_PAM}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_Radovich2018.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_Radovich2018_PAM"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ans[[5]]$clrs[[2]] # 5
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_Radovich2018.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_Radovich2018.RData"))
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_Radovich.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
text(-1, .96, "(e)")

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_Radovich_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(c) ", mmain))
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("Radovich", "CCP2", tmp, NA)
```


<table>
<tbody>
<tr>
<td><img src="./SE20201003_Radovich2018_PAM/consensus008.png"></td>
<td><img src="./SE20201003_Radovich2018_PAM/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_Radovich2018_PAM/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_Radovich_consensus.png"></td>
</tr>
</tbody>
</table>



# TCGA (2015) procedure
[Comprehensive, Integrative Genomic Analysis of Diffuse Lower-Grade Gliomas](https://www.nejm.org/doi/full/10.1056/NEJMoa1402121) - [Supplementary Appendix (see pages 23-24)](https://www.nejm.org/doi/suppl/10.1056/NEJMoa1402121/suppl_file/nejmoa1402121_appendix_1.pdf)

## hclust (Euclidean/Ward)
```{r TCGA2015}
#... using RSEM (Li and Dewey, 2011) and normalized within-sample to a fixed upper quartile. 
  suppressPackageStartupMessages(require(EDASeq))

system.time({
  ans <- newSeqExpressionSet(ddata)
  ans <- betweenLaneNormalization(ans, which = "upper", round = FALSE) 
  normCounts <- normCounts(ans)
#Gene-level data was restricted to genes expressed in at least 70% of samples. 
  tmp <- rowMeans(normCounts > 0)
  #sum(tmp > 0.7) #[1] 14909
  normCounts <- normCounts[tmp > 0.7,] #[1] 14909   150
#Data were Log2 transformed and median centered across samples prior to further analysis. 
  exprData <- log2(1 + t(normCounts))
#median centered across samples prior to further analysis. 
  mmedian <- colMedians(exprData)
  exprData <- scale(exprData, center = mmedian, scale = FALSE)
#The most variable genes were selected as the 1500 genes with the highest median absolute deviation. 
  tmp <- tail(sort(apply(exprData, 2, mad)), 1500)
  exprData <- exprData[, names(tmp)]#[1]  150 1500
})
#   user  system elapsed 
#  3.302   0.034   3.335 
timing <- c(3.302, 0.034, 3.335)
###
mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_TCGA.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
add_Calinski_curve(from = 25, to = 120)
text(-1, .96, "(d)")
if(save_png) png(file = paste0(jobName, "_TCGA_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = paste0("(d) ", mmain), col = clust.col)

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("TCGA", "HC", tmp, round(timing[3], 4))
```

## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r TCGA2015ccp}
if(!file.exists(paste0(jobName, "_ccp_hclust_TCGA.RData"))) {
#Consensus clustering was performed using ConsensusClusterPlus (Wilkerson and Hayes, 2010) #(1000 iterations, resample rate of 80%, and Pearson correlation)
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, distance = "pearson",
                              title = paste0(jobName, "_TCGA2015"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccp_hclust_TCGA.RData"))
  } else load(paste0(jobName, "_ccp_hclust_TCGA.RData"))
###
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccp_hclust_TCGA.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
text(-1, .96, "(d)")
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("TCGA", "CCP1", tmp, NA)

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_TCGA_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(d) ", mmain))
  dev.off()
}
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_TCGA2015/consensus008.png"></td>
<td><img src="./SE20201003_TCGA2015/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_TCGA2015/consensus005.png"></td>
<td><img src="./SE20201003_ccp_hclust_TCGA_consensus.png"></td>
</tr>
</tbody>
</table>


## ConsensusClusterPlus (PAM)
Result of ConsensuClusterPlus with clusterAlg = "pam" and distance = "euclidean" (other parameters left to default)
```{r TCGA2015ccp_PAM}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_TCGA.RData"))) {
#Consensus clustering was performed using ConsensusClusterPlus (Wilkerson and Hayes, 2010) #(1000 iterations, resample rate of 80%, and Pearson correlation)
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_TCGA2015_PAM"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_TCGA.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_TCGA.RData"))
  ###
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_TCGA.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
text(-1, .96, "(d)")
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_TCGA_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(d) ", mmain))
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("TCGA", "CCP2", tmp, NA)
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_TCGA2015_PAM/consensus008.png"></td>
<td><img src="./SE20201003_TCGA2015_PAM/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_TCGA2015_PAM/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_TCGA_consensus.png"></td>
</tr>
</tbody>
</table>



# FPKM: Top 2500 features
```{r}
system.time({
  exprData <- get_FPKM(ddata, feature_annotation$GeneLength)
  exprData <- log2(1 + exprData)
})
#   user  system elapsed 
#  0.134   0.000   0.134 
timing <- c(0.134, 0.000, 0.134)
tmp <- apply(exprData, 2, var)
tmp <- names(tail(sort(tmp), 2500))
exprData <-  scale(exprData[, tmp])
###
mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 9)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_FPKM25.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, 150, hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
text(-1, .96, "(e)")
if(save_png) png(file = paste0(jobName, "_FPKM25_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = paste0("(e) ", mmain), col = clust.col)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("FPKM (2,500HVG)", "HC", tmp, round(timing[3], 4))
```

## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r FPKM25ccp}
if(!file.exists(paste0(jobName, "_ccp_hclust_FPKM25.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              title = paste0(jobName, "_FPKM25"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccp_hclust_FPKM25.RData"))
  } else load(paste0(jobName, "_ccp_hclust_FPKM25.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccp_hclust_FPKM25.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_FPKM25_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(e) ", mmain))
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("FPKM (2,500HVG)", "CCP1", tmp, NA)

```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_FPKM25/consensus008.png"></td>
<td><img src="./SE20201003_FPKM25/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_FPKM25/consensus005.png"></td>
<td><img src="./SE20201003_ccp_hclust_FPKM25_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>

## ConsensusClusterPlus (PAM)
Result of ConsensuClusterPlus with clusterAlg = "pam" and distance = "euclidean" (other parameters left to default)
```{r FPKM25ccp_PAM}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_FPKM25.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200413)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_FPKM25_PAM"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_FPKM25.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_FPKM25.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
if(Inf %in% aCalinski) aCalinski <- aCalinski[!is.infinite(aCalinski)]
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_FPKM25.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_FPKM25_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(e) ", mmain))
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("FPKM (2,500HVG)", "CCP2", tmp, NA)
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_FPKM25_PAM/consensus008.png"></td>
<td><img src="./SE20201003_FPKM25_PAM/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_FPKM25_PAM/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_FPKM25_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>



# FPKM: Top 5000 features
```{r}
exprData <- get_FPKM(ddata, feature_annotation$GeneLength)
exprData <- log2(1 + exprData)
HVG <- apply(exprData, 2, var)
HVG <- names(tail(sort(HVG), 5000))
exprData <-  scale(exprData[, HVG])
###
mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 9)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_FPKM5k.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
text(-1, .96, "(f)")
if(save_png) png(file = paste0(jobName, "_FPKM5k_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = paste0("(f) ", mmain), col = clust.col)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("FPKM (5,000HVG)", "HC", tmp, NA)
```


## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r FPKM5kccp}
if(!file.exists(paste0(jobName, "_ccp_hclust_FPKM5k.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              title = paste0(jobName, "_FPKM5k"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccp_hclust_FPKM5k.RData"))
  } else load(paste0(jobName, "_ccp_hclust_FPKM5k.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccp_hclust_FPKM5k.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_FPKM5k_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(f) ", mmain))
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("FPKM (5,000HVG)", "CCP1", tmp, NA)
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_FPKM5k/consensus008.png"></td>
<td><img src="./SE20201003_FPKM5k/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_FPKM5k/consensus005.png"></td>
<td><img src="./SE20201003_ccp_hclust_FPKM5k_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>


## ConsensusClusterPlus (PAM)
Result of ConsensuClusterPlus with clusterAlg = "pam" and distance = "euclidean" (other parameters left to default)
```{r FPKM5kccp_PAM}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_FPKM5k.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200413)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_FPKM5k_PAM"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_FPKM5k.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_FPKM5k.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_FPKM5k.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_FPKM5k_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(f) ", mmain))
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("FPKM (5,000HVG)", "CCP2", tmp, NA)
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_FPKM5k_PAM/consensus008.png"></td>
<td><img src="./SE20201003_FPKM5k_PAM/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_FPKM5k_PAM/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_FPKM5k_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>


# VST (DESeq2): all features
```{r}
if(!file.exists(paste0(jobName, "_vst.RData"))) {
  library(DESeq2)
  system.time({exprData <- t(vst(ddata))})
#   user    system  elapsed 
#  3.002   0.068   3.068 
  timing <- c(3.002, 0.068, 3.068)
  save(exprData, timing, file = paste0(jobName, "_vst.RData"))
} else load(paste0(jobName, "_vst.RData"))

mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 9)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_vst.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
text(-1, .96, "(h)")
if(save_png) png(file = paste0(jobName, "_vst_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = paste0("(h) ", mmain), col = clust.col)
dev.off()

asw <- mean(ssil[, 3])
tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("VST", "HC", tmp, round(timing[3], 4))
```


## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r VSTccp}
if(!file.exists(paste0(jobName, "_ccp_hclust_vst.RData"))) {
#Consensus clustering was performed using ConsensusClusterPlus (Wilkerson and Hayes, 2010) #(1000 iterations, resample rate of 80%, and Pearson correlation)
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, distance = "pearson",
                              title = paste0(jobName, "_VST"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccp_hclust_vst.RData"))
  } else load(paste0(jobName, "_ccp_hclust_vst.RData"))
###
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
if(Inf %in% aCalinski) aCalinski <- aCalinski[!is.infinite(aCalinski)]
hhc$height <- hhc$height/max(hhc$height)
#if(save_png) png(file = paste0(jobName, "_ccp_hclust_vst.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
#dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("VST", "CCP1", tmp, NA)

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_vst_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(h) ", mmain))
  dev.off()
}
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_VST/consensus008.png"></td>
<td><img src="./SE20201003_VST/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_VST/consensus005.png"></td>
<td><img src="./SE20201003_ccp_hclust_vst_consensus.png"></td>
</tr>
</tbody>
</table>


## ConsensusClusterPlus (PAM)
Result of ConsensuClusterPlus with clusterAlg = "pam" and distance = "euclidean" (other parameters left to default)
```{r VSTccp_PAM}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_VST.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200413)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_VST_PAM"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_VST.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_VST.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
if(Inf %in% aCalinski) aCalinski <- aCalinski[!is.infinite(aCalinski)]
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_VST.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_vst_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(h) ", mmain))
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("VST", "CCP2", tmp, NA)
```


<table>
<tbody>
<tr>
<td><img src="./SE20201003_VST_PAM/consensus008.png"></td>
<td><img src="./SE20201003_VST_PAM/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_VST_PAM/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_vst_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>


# rLog (DESeq2): all features
```{r}
if(!file.exists(paste0(jobName, "_rld.RData"))) {
  require(DESeq2)
  dds <- DESeqDataSetFromMatrix(countData = ddata, 
                                colData = annotation.df, 
                                rowData = feature_annotation, 
                                design = ~1)
  system.time({rld <- rlog(dds, blind=FALSE)})
  #    user   system  elapsed 
  # 927.281    0.464  927.896 
  timing <- c(927.281, 0.464, 927.896)
  
  exprData <- t(assay(rld))
  save(exprData, timing, file = paste0(jobName, "_rld.RData"))
} else load(paste0(jobName, "_rld.RData"))
###
mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 9)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_rlog.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
text(-1, .96, "(g)")
if(save_png) png(file = paste0(jobName, "_rlog_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = paste0("(g) ", mmain), col = clust.col)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("rLog", "HC", tmp, round(timing[3], 4))
```


## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r rlog ccp}
if(!file.exists(paste0(jobName, "_ccp_hclust_rlog.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, distance = "pearson",
                              title = paste0(jobName, "_rlog"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccp_hclust_rlog.RData"))
  } else load(paste0(jobName, "_ccp_hclust_rlog.RData"))
###
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccp_hclust_rlog.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("rLog", "CCP1", tmp, NA)

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_rlog_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(g) ", mmain))
  dev.off()
}
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_rlog/consensus008.png"></td>
<td><img src="./SE20201003_rlog/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_rlog/consensus005.png"></td>
<td><img src="./SE20201003_ccp_hclust_rlog_consensus.png"></td>
</tr>
</tbody>
</table>


## ConsensusClusterPlus (PAM)
Result of ConsensuClusterPlus with clusterAlg = "pam" and distance = "euclidean" (other parameters left to default)
```{r rlog ccp_PAM}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_rlog.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200413)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_rlog_PAM"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_rlog.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_rlog.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_rlog.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_rlog_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(g) ", mmain))
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("rLog", "CCP2", tmp, NA)
```


<table>
<tbody>
<tr>
<td><img src="./SE20201003_rlog_PAM/consensus008.png"></td>
<td><img src="./SE20201003_rlog_PAM/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_rlog_PAM/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_rlog_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>



# rLog (DESeq2) 2,500 HVG
```{r}
HVG <- apply(exprData, 2, var)
HVG <- names(tail(sort(HVG), 2500))
exprData <-  exprData[, HVG]
###
mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 9)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_rlog2500.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png) png(file = paste0(jobName, "_rlog2500_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = mmain, col = clust.col)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("rLog (2,500HVG)", "HC", tmp, NA)
```


## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r rlog2500 ccp}
if(!file.exists(paste0(jobName, "_ccp_hclust_rlog2500.RData"))) {
#Consensus clustering was performed using ConsensusClusterPlus (Wilkerson and Hayes, 2010) #(1000 iterations, resample rate of 80%, and Pearson correlation)
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, distance = "pearson",
                              title = paste0(jobName, "_rlog2500"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccp_hclust_rlog2500.RData"))
  } else load(paste0(jobName, "_ccp_hclust_rlog2500.RData"))
###
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
if(Inf %in% aCalinski) aCalinski <- aCalinski[!is.infinite(aCalinski)]
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccp_hclust_rlog2500.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
#text(-1, .96, "(d)")
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("rLog (2,500HVG)", "CCP1", tmp, NA)

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_rlog2500_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, clusterColors = thisPalette)
  dev.off()
}
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_rlog2500/consensus008.png"></td>
<td><img src="./SE20201003_rlog2500/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_rlog2500/consensus005.png"></td>
<td><img src="./SE20201003_ccp_hclust_rlog2500_consensus.png"></td>
</tr>
</tbody>
</table>



## ConsensusClusterPlus (PAM)
Result of ConsensuClusterPlus with clusterAlg = "pam" and distance = "euclidean" (other parameters left to default)
```{r rlog2500 ccp_PAM}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_rlog2500.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200413)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_rlog2500_PAM"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_rlog2500.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_rlog2500.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
if(Inf %in% aCalinski) aCalinski <- aCalinski[!is.infinite(aCalinski)]
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_rlog2500.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_rlog2500_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, clusterColors = thisPalette)
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("rLog (2,500HVG)", "CCP2", tmp, NA)
```


<table>
<tbody>
<tr>
<td><img src="./SE20201003_rlog2500_PAM/consensus008.png"></td>
<td><img src="./SE20201003_rlog2500_PAM/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_rlog2500_PAM/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_rlog2500_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>

# Townes/deviance (scry)
```{r Townes/scry deviance}
if(!file.exists(paste0(jobName, "_scry.RData"))) {
  library(scry)
  system.time({exprData_deviance <- nullResiduals(ddata, type = "deviance")})
#   user  system elapsed 
#  0.216   0.000   0.216 
  timing_dev <- c(0.216, 0.000, 0.216)
  write.table(exprData_deviance, sep = "\t", quote = FALSE, file = "townes_exprData_deviance.tsv")
  system.time({exprData_pearson <- nullResiduals(ddata, type = "pearson")})
#  user  system elapsed 
#  0.049   0.000   0.048 
  timing_pears <- c(0.049, 0.000, 0.048)
  write.table(exprData_pearson, sep = "\t", quote = FALSE, file = "townes_exprData_pearson.tsv")
  
#  exprData_deviance <- read.csv("townes_exprData_deviance.tsv", sep = "\t")
#  exprData_deviance <- as.matrix(t(exprData_deviance))

#  exprData_pearson <- read.csv("townes_exprData_pearson.tsv", sep = "\t")
#  exprData_pearson <- as.matrix(t(exprData_pearson))
  save(exprData_deviance, timing_dev, exprData_pearson, timing_pears, file = paste0(jobName, "_scry.RData"))
} else load(paste0(jobName, "_scry.RData"))

exprData <- t(na.omit(t(exprData_deviance)))
mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 9)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_scry_dev.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
text(-1, .96, "(i)")
dev.off()

if(save_png) png(file = paste0(jobName, "_scry_dev_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = paste0("(i) ", mmain), col = clust.col)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("Townes/deviance", "HC", tmp, round(timing_dev[3], 4))
```


## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r scry deviance ccp}
if(!file.exists(paste0(jobName, "_ccp_hclust_scry_dev.RData"))) {
#Consensus clustering was performed using ConsensusClusterPlus (Wilkerson and Hayes, 2010) #(1000 iterations, resample rate of 80%, and Pearson correlation)
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, distance = "pearson", 
                              title = paste0(jobName, "_scry_dev"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, 
       file = paste0(jobName, "_ccp_hclust_scry_dev.RData"))
  } else load(paste0(jobName, "_ccp_hclust_scry_dev.RData"))
###
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
if(Inf %in% aCalinski) aCalinski <- aCalinski[!is.infinite(aCalinski)]
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccp_hclust_scry_dev.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("Townes/deviance", "CCP1", tmp, NA)

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_scry_dev_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(i) ", mmain))
dev.off()
}
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_scry_dev/consensus008.png"></td>
<td><img src="./SE20201003_scry_dev/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_scry_dev/consensus005.png"></td>
<td><img src="./SE20201003_ccp_hclust_scry_dev_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>



## ConsensusClusterPlus (PAM)
```{r scry deviance ccp_PAM}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_scry_dev.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200413)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_scry_dev_PAM"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_scry_dev.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_scry_dev.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_scry_dev.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_scry_dev_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(i) ", mmain))
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("Townes/deviance", "CCP2", tmp, NA)
```


<table>
<tbody>
<tr>
<td><img src="./SE20201003_scry_dev_PAM/consensus008.png"></td>
<td><img src="./SE20201003_scry_dev_PAM/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_scry_dev_PAM/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_scry_dev_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>


# Townes/deviance (scry) 2,500HVG
```{r Townes/scry deviance 2,500HVG}
load(paste0(jobName, "_scry.RData"))
exprData <- t(na.omit(t(exprData_deviance)))
HVG <- apply(exprData, 2, var)
HVG <- names(tail(sort(HVG), 2500))
exprData <-  exprData[, HVG]

mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 9)
hhc$height <- hhc$height/max(hhc$height)
#if(save_png) png(file = paste0(jobName, "_scry_dev.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)

#if(save_png) png(file = paste0(jobName, "_scry_dev_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = mmain, col = clust.col)

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("Townes/deviance (2,500HVG)", "HC", tmp, NA)
```


## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r scry deviance ccp 2,500HVG}
if(!file.exists(paste0(jobName, "_ccp_hclust_scry_dev_2k5HVG.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, distance = "pearson", 
                              title = paste0(jobName, "_scry_dev_2k5HVG"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccp_hclust_scry_dev_2k5HVG.RData"))
  } else load(paste0(jobName, "_ccp_hclust_scry_dev_2k5HVG.RData"))
###
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
if(Inf %in% aCalinski) aCalinski <- aCalinski[!is.infinite(aCalinski)]
hhc$height <- hhc$height/max(hhc$height)
#if(save_png) png(file = paste0(jobName, "_ccp_hclust_scry_dev_2k5HVG.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("Townes/deviance (2,500HVG)", "CCP1", tmp, NA)

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_scry_dev_2k5HVG_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
plot(ccp, rep = 1000, clustering = annotation.df$sample.col, clusterColors = thisPalette)
}
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_scry_dev_2k5HVG/consensus008.png"></td>
<td><img src="./SE20201003_scry_dev_2k5HVG/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_scry_dev_2k5HVG/consensus005.png"></td>
<td><img src="./SE20201003_ccp_hclust_scry_dev_2k5HVG_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>



## ConsensusClusterPlus (PAM)
```{r scry deviance ccp_PAM 2,500HVG}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_scry_dev_2k5HVG.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200413)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_scry_dev_PAM_2k5HVG"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_scry_dev_2k5HVG.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_scry_dev_2k5HVG.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
#if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_scry_dev_2k5HVG.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_scry_dev_2k5HVG_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
plot(ccp, rep = 1000, clustering = annotation.df$sample.col, clusterColors = thisPalette)
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("Townes/deviance (2,500HVG)", "CCP2", tmp, NA)
```


<table>
<tbody>
<tr>
<td><img src="./SE20201003_scry_dev_PAM_2k5HVG/consensus008.png"></td>
<td><img src="./SE20201003_scry_dev_PAM_2k5HVG/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_scry_dev_PAM_2k5HVG/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_scry_dev_2k5HVG_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>



# Townes/pearson (scry)
```{r Townes/scry pearson}
exprData <-  t(na.omit(t(exprData_pearson)))
mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 9)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_scry_pears.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
text(-1, .96, "(l)")
if(save_png) png(file = paste0(jobName, "_scry_pears_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = paste0("(l) ", mmain), col = clust.col)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("Townes/pearson", "HC", tmp, round(timing_pears[3], 4))
```



## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r scry pearson ccp}
if(!file.exists(paste0(jobName, "_ccp_hclust_scry_pears.RData"))) {
#Consensus clustering was performed using ConsensusClusterPlus (Wilkerson and Hayes, 2010) #(1000 iterations, resample rate of 80%, and Pearson correlation)
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, distance = "pearson", 
                              title = paste0(jobName, "_scry_pears"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccp_hclust_scry_pears.RData"))
  } else load(paste0(jobName, "_ccp_hclust_scry_pears.RData"))
###
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccp_hclust_scry_pears.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("Townes/pearson", "CCP1", tmp, NA)

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_scry_pears_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(l) ", mmain))
  dev.off()
}
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_scry_pears/consensus008.png"></td>
<td><img src="./SE20201003_scry_pears/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_scry_pears/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_scry_pears_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>


## ConsensusClusterPlus (PAM)
```{r scry pearson ccp_PAM}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_scry_pears.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200413)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_scry_pears_PAM"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_scry_pears.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_scry_pears.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_scry_pears.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_scry_pears_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, 
       clusterColors = thisPalette, main = paste0("(l) ", mmain))
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("Townes/perason", "CCP2", tmp, NA)
```




<table>
<tbody>
<tr>
<td><img src="./SE20201003_scry_pears_PAM/consensus008.png"></td>
<td><img src="./SE20201003_scry_pears_PAM/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_scry_pears_PAM/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_scry_pears_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>


# Townes/pearson (scry) 2,500HVG
```{r Townes/scry pearson 2k5HVG}
exprData <-  t(na.omit(t(exprData_pearson)))
HVG <- apply(exprData, 2, var)
HVG <- names(tail(sort(HVG), 2500))
exprData <-  exprData[, HVG]
mmain <- paste0(nrow(exprData), " samples/", ncol(exprData), " genes")
hhc <- hclust(ddist <- dist(exprData), method = "ward.D2")
aCalinski <- calinski(hhc, gMax = 9)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_scry_pears_2k5HVG.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
#text(-1, .96, "(h)")
if(save_png) png(file = paste0(jobName, "_scry_pears_2k5HVG_silhouttes.png"), width = png_width, height = png_height)
ssil <- silhouette(as.numeric(annotation.df$sample.col), ddist)
plot(ssil, main = mmain, col = clust.col)

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], round(mean(ssil[,3]), 4))
results[k <- k+1,] <- c("Townes/pearson (2,500HVG)", "HC", tmp, NA)
```



## ConsensusClusterPlus (default parameters)
Result of ConsensuClusterPlus with default setup <br/>(innerLinkage="average", finalLinkage="average", distance="pearson")
```{r scry pearson ccp 2k5HVG}
if(!file.exists(paste0(jobName, "_ccp_hclust_scry_pears_2k5HVG.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200427)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, distance = "pearson", 
                              title = paste0(jobName, "_scry_pears_2k5HVG"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccp_hclust_scry_pears_2k5HVG.RData"))
  } else load(paste0(jobName, "_ccp_hclust_scry_pears_2k5HVG.RData"))
###
mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccp_hclust_scry_pears_2k5HVG.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("Townes/pearson (2,500HVG)", "CCP1", tmp, NA)

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccp_hclust_scry_pears_2k5HVG_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, clusterColors = thisPalette)
  dev.off()
}
```

<table>
<tbody>
<tr>
<td><img src="./SE20201003_scry_pears_2k5HVG/consensus008.png"></td>
<td><img src="./SE20201003_scry_pears_2k5HVG/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_scry_pears_2k5HVG/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_scry_pears_2k5HVG_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>


## ConsensusClusterPlus (PAM)
```{r scry pearson ccp_PAM_2k5HVG}
if(!file.exists(paste0(jobName, "_ccpPAM_hclust_scry_pears_2k5HVG.RData"))) {
  require(ConsensusClusterPlus)
  set.seed(20200413)
  ans <- ConsensusClusterPlus(t(exprData), maxK = 7, reps = 1000, 
                              clusterAlg = "pam", distance = "euclidean",
                              title = paste0(jobName, "_scry_pears_2k5HVG_PAM"), plot = "png")
  ncol_exprData <- ncol(exprData)
  nrow_exprData <- nrow(exprData)
  ccp <- ans[[5]]
  class(ccp) <- "ConsensusClusterPlus"
  hhc <- ccp$consensusTree
  save(hhc, ccp, nrow_exprData, ncol_exprData, jobName, file = paste0(jobName, "_ccpPAM_hclust_scry_pears_2k5HVG.RData"))
  } else load(paste0(jobName, "_ccpPAM_hclust_scry_pears_2k5HVG.RData"))

mmain <- paste0(nrow_exprData, " samples/", ncol_exprData, " genes")
aCalinski <- calinski(hhc, gMax = 7)
hhc$height <- hhc$height/max(hhc$height)
if(save_png) png(file = paste0(jobName, "_ccpPAM_hclust_scry_pears_2k5HVG.png"), width = png_width, height = png_height, res = png_res)
plot(hhc, hang = -1, labels = FALSE, xlab = "", sub = "", main = mmain)
add_Calinski_curve(from = 25, to = 120)
wwhere <- 5
hh <- mean(c(hhc$height[length(hhc$height)-wwhere+2], hhc$height[length(hhc$height)-wwhere+1]))
segments(1, hh, nrow(exprData), hh, col = "red")
clustering <- as.factor(cutree(hhc, k = wwhere))
names(clustering) <- hhc$labels
levels(clustering) <- thisPalette
tmp.col <- cbind(as.character(clustering), as.character(annotation.df$sample.col))
colnames(tmp.col) <- c("clust", "sample")
colored_bars(colors = tmp.col, dend = as.dendrogram(hhc), y_scale = y_scale_, y_shift = y_shift_)
dev.off()

if(save_png & ("plot.ConsensusClusterPlus" %in% ls())) {
  png(file = paste0(jobName, "_ccpPAM_hclust_scry_pears_2k5HVG_consensus.png"), 
      width = png_width, height = png_width, res = png_res)
  plot(ccp, rep = 1000, clustering = annotation.df$sample.col, clusterColors = thisPalette)
  dev.off()
}

tmp.col <- as.data.frame(tmp.col)
tmp <- c(get_metrics(tmp.col$sample, tmp.col$clust)[1:4], NA)
results[k <- k+1,] <- c("Townes/pearson (2,500HVG)", "CCP2", tmp, NA)
```




<table>
<tbody>
<tr>
<td><img src="./SE20201003_scry_pears_2k5HVG_PAM/consensus008.png"></td>
<td><img src="./SE20201003_scry_pears_2k5HVG_PAM/consensus009.png"></td>
</tr>
<tr>
<td><img src="./SE20201003_scry_pears_2k5HVG_PAM/consensus005.png"></td>
<td><img src="./SE20201003_ccpPAM_hclust_scry_pears_2k5HVG_consensus.png"></td>
<td></td>
</tr>
</tbody>
</table>



# Table of the experiments
```{r}
results <- as.data.frame(results)
results <- results[!is.na(results$ARI),]
kable(results)

write.table(results, file = paste0(jobName, "_results.tsv"), sep = "\t", quote = FALSE, row.names = FALSE)
```

HC) hirerachical clustering with Ward's likage and Euclidean distance; CPP1) ConsensusClusterPlus with average innner and outer linkage, and Pearson's correlation as distance; CCP2) ConsensusClusterPlus with PAM and Euclidean distance;


```{r supp table 1, eval = FALSE}
ttable <- read.csv(paste0(jobName, "_results.tsv"), sep = "\t")[, -8]
library(xtable)
x.table <- xtable(ttable)
print(xtable(ttable), include.rownames = FALSE)
```


```{r supp table 2, eval = FALSE}
ttable <- read.csv(paste0(jobName, "_results.tsv"), sep = "\t")
ttable <- ttable[!is.na(ttable$timing), -(2:7)]
ttable$ratio <- round(ttable$timing/ttable$timing[1], 3)
kable(ttable)
library(xtable)
x.table <- xtable(ttable)
print(xtable(ttable), include.rownames = FALSE)


```




# Average Silhouettes Width

```{r Average_Silhouettes_Width.png}
ttable <- read.csv(paste0(jobName, "_results.tsv"), sep = "\t")
ttable <- ttable[!is.na(ttable$ASW),]

if(save_png) png(file = paste0(jobName, "_Average_Silhouettes_Width.png"), width = png_width, height = 350, res = png_res)
bp <- barplot(ttable$ASW, ylab = "Average Silhouettes Width", border = NA, col = "gray80")
what <- as.character(ttable$what)
text(bp-0.25, 0.01, what, srt = 90, pos = 4, cex = 1.1)
dev.off()
knit_exit()
```


# Session info

```{r}
sessionInfo()
knit_exit()
```

```{r}
rm(list = ls())
setwd("~/Dropbox/AWST/gitHub/SD20200413/")
ttable <- read.csv("SE20201003_results.tsv", sep = "\t")
HC <- ttable$G[grep("HC", ttable$with)]
names(HC)<- ttable$what[grep("HC", ttable$with)]
CCP1 <- ttable$G[grep("CCP1", ttable$with)]
names(CCP1)<- ttable$what[grep("CCP1", ttable$with)]
CCP2 <- ttable$G[grep("CCP2", ttable$with)]
names(CCP2)<- ttable$what[grep("CCP2", ttable$with)]

ppalette <- c("red", "green3", "blue", "cyan2", "magenta", "gold")
xx <- c(rep(1, length(HC)), rep(2, length(CCP1)), rep(3, length(CCP2)))
yy <- c(HC, CCP1, CCP2)
ccol <- rep(ppalette, 3)
plot(xx, yy, ylim = c(0, 1), col = ccol, pch = 19, xlab = NA, ylab = "performance", bty = "n", xaxt = "n")
segments(rep(1, length(HC)), HC, rep(2, length(HC)), CCP1, col = ppalette)
segments(rep(2, length(HC)), CCP1, rep(3, length(HC)), CCP2, col = ppalette)
text(c(1, 2, 3), c(0, 0, 0), c("HC", "CCP1", "CCP2"))
text(rep(1, length(HC)), HC, names(HC))
```

```{r}
rm(list = ls())
setwd("~/Dropbox/AWST/gitHub/SD20200413/")
ttable <- read.csv("SE20201003_results.tsv", sep = "\t")
ttable <- ttable[!is.na(ttable$ASW),]
png(file = paste0(jobName, "Average_Silhouettes_Width.png"), 
      width = png_width, height = png_height, res = png_res)
bp <- barplot(ttable$ASW, ylab = "Average Silhouettes Width", border = NA, col = "#A6CEE3")
what <- as.character(ttable$what)
what <- c("AWST", "Hart", "Radovich (1,000 features)", "TCGA (1,500 features)", "FPKM (2,500 features)", "FPKM (5,000 features)", "VST", "rlog (2,500 features)", "rlog", "Townes/deviance", "Townes/pearson") 
text(bp, 0.01, what, srt = 90, pos = 4, cex = 1.1)
dev.off()


thisPalette <- c("#A6CEE3", "#1F78B4", "#B2DF8A", "#33A02C", "#FB9A99") # from ConsensusClusterPlus
```



